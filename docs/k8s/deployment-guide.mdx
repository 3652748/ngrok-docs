import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Deployment Guide

This guide is meant as the starting point for configuring, deploying, and operating the controller component itself. It focuses on configurations and settings for the whole controller, and thus its corresponding ingress class, rather than individual ingress resources and their annotations.

## Prerequisites

- A k8s cluster and access to it via kubectl - We recommend using a recent version of k8s and will specify and test past versions as a part of https://github.com/ngrok/kubernetes-ingress-controller/issues/154
- helm - 3.0.0 or later.

## Installation

<Tabs groupId="k8s" queryString="k8s-basic">
	<TabItem value="ingress" label="Ingress Controller" default>

	</TabItem>
	<TabItem value="gatewayAPI" label="Gateway API">

	</TabItem>
</Tabs>

It is recommended to use helm to install the operator. Alternatively, the container is available on docker hub at `ngrok/ingress-controller` and can be run directly with hand crafted manifests.

To install via helm, run the following commands to export your credentials as environment variables and add the operator to helm:

```bash
export NGROK_API_KEY=<YOUR Secret API KEY>
export NGROK_AUTHTOKEN=<YOUR Secret Auth Token>
helm repo add ngrok https://ngrok.github.io/kubernetes-ingress-controller
```

<Tabs groupId="k8s" queryString="k8s-basic">
	<TabItem value="ingress" label="Ingress Controller" default>
Run the following commands to instal the ingress controller 
```bash
helm install ngrok-ingress-controller ngrok/kubernetes-ingress-controller \
  --namespace ngrok-ingress-controller \
  --create-namespace \
  --set credentials.apiKey=$NGROK_API_KEY \
  --set credentials.authtoken=$NGROK_AUTHTOKEN
```
	</TabItem>
	<TabItem value="gatewayAPI" label="Gateway API">
Run the following commands to instal the core Gateway API CRDs and the Gateway API components of the ngrok Kubernetes Operator 
```bash
kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml
helm install ngrok-ingress-controller ngrok/kubernetes-ingress-controller \
  --namespace ngrok-ingress-controller \
  --create-namespace \
  --set credentials.apiKey=$NGROK_API_KEY \
  --set credentials.authtoken=$NGROK_AUTHTOKEN
    --set useExperimentalGatewayApi=true
```
	</TabItem>
</Tabs>



For a more robust _infrastructure as code_ way of passing your credentials, see the [credentials](./credentials#setup) page.

Once installed and healthy, you can try creating an ingress object using the output example from the helm install!

### Alternatively

For a quick install, you can also use the combined manifests directly from the repo and begin changing resources:

```bash
kubectl apply -n ngrok-ingress-controller -f https://raw.githubusercontent.com/ngrok/kubernetes-ingress-controller/main/manifest-bundle.yaml
```

## Credentials

In order to use the ngrok Kubernetes Ingress Controller, you will need a paid ngrok account. We are working on bringing the full experience to the free tier, and we will update this documentation when that is released. Once you have an account, you will need to log into the [ngrok dashboard](https://dashboard.ngrok.com) to gather the necessary credentials.

You will need two things from the dashboard:

- Your auth token, which can be found [here](https://dashboard.ngrok.com/auth/your-authtoken)
- An API key, which can be found [here](https://dashboard.ngrok.com/api)

These credentials will be created as a Kubernetes secret, which the controller will have access to. The auth token is used to create tunnels, and the API key is used to manage edges and other resources via the ngrok API.

### Setup

While the quickstart guide shows you can pass the credential values directly via helm values, we do not recommend this for production scenarios. Instead, we recommend creating a Kubernetes secret and passing the secret name to the helm chart. This allows for easier infrastructure as code in a more secure manner.

### Creating the Secret

To create the secret, follow these steps:

- Make sure the secret is in the same namespace as the ingress controller
- Use a well-formed name that can be passed to the helm chart
- Add two keys to the secret: `API_KEY` and `AUTHTOKEN`

Here is an example secret manifest:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: ngrok-ingress-controller-credentials
  namespace: ngrok-ingress-controller
data:
  API_KEY: "YOUR-API-KEY-BASE64"
  AUTHTOKEN: "YOUR-AUTHTOKEN-BASE64"
```

## Other Topics

Below are various other topics for a deployer or operator to be aware of.

- [common helm overrides](./common-helm-k8s-overrides)
- [multiple installations](./multiple-installations)
- [white label agent ingress](./white-label-agent-ingress)
- [metrics](./metrics)
- [ngrok regions](./ngrok-regions)
